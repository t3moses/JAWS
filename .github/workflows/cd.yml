# Continuous Deployment workflow
# REQUIRED SETUP:
# 1. Create "production" environment in: Repo Settings → Environments → New environment
# 2. Add required reviewers (e.g., "robjohnston", "t3moses")
# 3. Optionally set deployment branches to "main" only
# 4. Add secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main, ci-cd_pipeline]  # Only deploy from main

permissions:
  contents: read
  actions: read

concurrency:
  group: production
  cancel-in-progress: false

jobs:
  check-ci-status:
    name: Verify CI Pipeline Passed
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      ci_passed: ${{ steps.check.outputs.ci_passed }}
    steps:
      - name: Check CI status
        id: check
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "ci_passed=true" >> $GITHUB_OUTPUT
            echo "✅ CI pipeline passed - ready for approval"
          else
            echo "ci_passed=false" >> $GITHUB_OUTPUT
            echo "❌ CI pipeline failed - deployment cancelled"
            exit 1
          fi

  deploy-production:
    name: Deploy to AWS Production
    runs-on: ubuntu-latest
    needs: check-ci-status

    # This environment configuration requires approval
    environment:
      name: production
      url: https://nsc-sdc.ca

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_commit }}

      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          name: vendor-artifacts
          path: vendor
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.event.workflow_run.head_repository.full_name }}

      - name: Download database artifacts
        uses: actions/download-artifact@v4
        with:
          name: database-artifacts
          path: database/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.event.workflow_run.head_repository.full_name }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ca-central-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        run: terraform init
        working-directory: terraform

      - name: Terraform plan
        run: terraform plan -out tfplan
        working-directory: terraform

      - name: Terraform apply
        run: terraform apply -auto-approve tfplan
        working-directory: terraform

      # If you replace the auto-generated key pair with an existing key pair,
      # update this step to write the private key from a secret instead.
      - name: Prepare SSH key
        run: |
          SSH_PRIVATE_KEY="$(terraform output -raw ssh_private_key)"
          mkdir -p ~/.ssh
          cat << 'EOF' > ~/.ssh/lightsail.pem
          $SSH_PRIVATE_KEY
          EOF
          chmod 600 ~/.ssh/lightsail.pem
        working-directory: terraform

      - name: Get instance IP
        id: terraform-outputs
        run: |
          INSTANCE_IP="$(terraform output -raw instance_ip)"
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
        working-directory: terraform

      - name: Add host to known_hosts
        run: ssh-keyscan -H ${{ steps.terraform-outputs.outputs.instance_ip }} >> ~/.ssh/known_hosts

      - name: Deploy backend
        run: |
          ssh -i ~/.ssh/lightsail.pem ubuntu@${{ steps.terraform-outputs.outputs.instance_ip }} << 'EOF'
            cd /var/www/html
            git pull origin main
            composer install --no-dev --optimize-autoloader
            vendor/bin/phinx migrate -e production
            sudo systemctl restart apache2 || sudo /opt/bitnami/ctlscript.sh restart apache
          EOF

      - name: Deploy frontend
        run: |
          rsync -avz -e "ssh -i ~/.ssh/lightsail.pem" \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude 'tests' \
            --exclude '.env' \
            public/ ubuntu@${{ steps.terraform-outputs.outputs.instance_ip }}:/var/www/html/

          ssh -i ~/.ssh/lightsail.pem ubuntu@${{ steps.terraform-outputs.outputs.instance_ip }} << 'EOF'
            sudo chown -R www-data:www-data /var/www/html
            sudo chmod -R 755 /var/www/html
          EOF

      - name: Smoke tests
        run: |
          sleep 5
          curl -f http://${{ steps.terraform-outputs.outputs.instance_ip }}/ || exit 1
          curl -f http://${{ steps.terraform-outputs.outputs.instance_ip }}/api/events || exit 1

      - name: Deployment success notification
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'notification.yml',
              ref: context.ref,
              inputs: {
                status: 'success',
                deployment: 'production'
              }
            });

      - name: Deployment failure notification
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            console.log('❌ Deployment failed - check logs for details');
