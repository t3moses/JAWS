# Continuous Deployment workflow
# REQUIRED SETUP:
# 1. Create "production" environment in: Repo Settings â†’ Environments â†’ New environment
# 2. Add required reviewers (e.g., "robjohnston", "t3moses")
# 3. Optionally set deployment branches to "main" only
# 4. Add secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY

name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  actions: read

concurrency:
  group: production-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  check-ci-status:
    name: Verify CI Pipeline Passed
    runs-on: ubuntu-latest
    # Only proceed if CI succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      ci_passed: ${{ steps.check.outputs.ci_passed }}
      branch: ${{ steps.check.outputs.branch }}
      run_id: ${{ steps.check.outputs.run_id }}
    steps:
      - name: Check CI status and capture metadata
        id: check
        run: |
          echo "âœ… CI pipeline passed - ready for deployment approval"
          echo "ci_passed=true" >> $GITHUB_OUTPUT
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT

          echo "ðŸ“‹ CI Run Details:"
          echo "  - Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "  - Run ID: ${{ github.event.workflow_run.id }}"
          echo "  - Commit: ${{ github.event.workflow_run.head_sha }}"
          echo "  - Event: ${{ github.event.workflow_run.event }}"

  ci-failed-notification:
    name: CI Failed - Deployment Cancelled
    runs-on: ubuntu-latest
    # Only run if CI failed
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    steps:
      - name: Report CI failure
        run: |
          echo "âŒ ================================"
          echo "âŒ CI PIPELINE FAILED"
          echo "âŒ ================================"
          echo "Deployment to production has been cancelled."
          echo ""
          echo "ðŸ“‹ CI Run Details:"
          echo "  - Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "  - Run ID: ${{ github.event.workflow_run.id }}"
          echo "  - Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "  - Event: ${{ github.event.workflow_run.event }}"
          echo ""
          echo "ðŸ” Next Steps:"
          echo "  1. Review the failed CI workflow run"
          echo "  2. Fix any test failures or linting issues"
          echo "  3. Push your fixes to trigger a new CI run"
          echo "  4. CD will automatically trigger when CI passes"
          exit 1

  deploy-production:
    name: Deploy to AWS Production
    runs-on: ubuntu-latest
    needs: check-ci-status

    # This environment configuration requires approval
    # IMPORTANT: If deployment doesn't wait for approval, the "production" environment
    # may not be configured. See setup instructions at the top of this file.
    environment:
      name: production
      url: https://nsc-sdc.ca   # a link to view the deployed environment (no impact on deployment).

    steps:
      - name: Deployment environment check
        run: |
          echo "ðŸš€ Starting deployment to production"
          echo "ðŸ“‹ Deployment Details:"
          echo "  - Branch: ${{ needs.check-ci-status.outputs.branch }}"
          echo "  - CI Run ID: ${{ needs.check-ci-status.outputs.run_id }}"
          echo "  - Environment: production"
          echo ""
          echo "âš ï¸  If this deployment started without approval, check that:"
          echo "  1. The 'production' environment exists in repository settings"
          echo "  2. Required reviewers are configured for the environment"
          echo "  3. Deployment branch rules are set (if applicable)"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          name: vendor-artifacts
          path: vendor
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false

      - name: Verify vendor artifacts
        run: |
          if [ ! -d "vendor" ] || [ -z "$(ls -A vendor)" ]; then
            echo "âŒ ERROR: Vendor artifacts not found or empty"
            echo "This may indicate:"
            echo "  1. Artifacts expired (retention: 1 day)"
            echo "  2. CI workflow didn't upload artifacts successfully"
            echo "  3. Artifact download failed"
            exit 1
          fi
          echo "âœ… Vendor artifacts verified"

      - name: Download database artifacts
        uses: actions/download-artifact@v4
        with:
          name: database-artifacts
          path: database/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false

      - name: Verify database artifacts
        run: |
          if [ ! -f "database/jaws.db" ]; then
            echo "âŒ ERROR: Database artifact not found"
            echo "This may indicate:"
            echo "  1. Artifacts expired (retention: 1 day)"
            echo "  2. CI workflow didn't upload database successfully"
            echo "  3. Artifact download failed"
            exit 1
          fi
          echo "âœ… Database artifacts verified"
          ls -lh database/jaws.db

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ca-central-1

      - name: Verify AWS credentials
        run: |
          if ! aws sts get-caller-identity > /dev/null 2>&1; then
            echo "âŒ ERROR: AWS credentials invalid or not configured"
            echo "Check that AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY are set correctly"
            exit 1
          fi
          echo "âœ… AWS credentials verified"
          aws sts get-caller-identity

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init
        working-directory: terraform

      - name: Terraform plan
        run: |
          echo "ðŸ“‹ Planning Terraform changes..."
          terraform plan -out tfplan
        working-directory: terraform

      - name: Terraform apply
        run: |
          echo "ðŸš€ Applying Terraform configuration..."
          terraform apply -auto-approve tfplan
          echo "âœ… Infrastructure provisioned successfully"
        working-directory: terraform

      # If you replace the auto-generated key pair with an existing key pair,
      # update this step to write the private key from a secret instead.
      - name: Prepare SSH key
        run: |
          echo "ðŸ”‘ Retrieving SSH key from Terraform..."
          SSH_PRIVATE_KEY="$(terraform output -raw ssh_private_key)"
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "âŒ ERROR: Failed to retrieve SSH private key from Terraform"
            exit 1
          fi
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/lightsail.pem
          chmod 600 ~/.ssh/lightsail.pem
          echo "âœ… SSH key configured"
        working-directory: terraform

      - name: Get instance IP
        id: terraform-outputs
        run: |
          echo "ðŸŒ Retrieving instance IP from Terraform..."
          INSTANCE_IP="$(terraform output -raw instance_ip)"
          if [ -z "$INSTANCE_IP" ]; then
            echo "âŒ ERROR: Failed to retrieve instance IP from Terraform"
            exit 1
          fi
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
          echo "âœ… Instance IP: $INSTANCE_IP"
        working-directory: terraform

      - name: Add host to known_hosts
        run: |
          echo "ðŸ” Adding host to known_hosts..."
          ssh-keyscan -H ${{ steps.terraform-outputs.outputs.instance_ip }} >> ~/.ssh/known_hosts
          echo "âœ… Host key verified"

      - name: Deploy backend
        run: |
          echo "ðŸš€ Deploying backend to production..."
          ssh -i ~/.ssh/lightsail.pem ubuntu@${{ steps.terraform-outputs.outputs.instance_ip }} << 'EOF'
            set -e
            echo "ðŸ“‚ Navigating to web directory..."
            cd /var/www/html

            echo "ðŸ“¥ Pulling latest code..."
            git pull origin ${{ needs.check-ci-status.outputs.branch }}

            echo "ðŸ“¦ Installing dependencies..."
            composer install --no-dev --optimize-autoloader

            echo "ðŸ—„ï¸  Running database migrations..."
            vendor/bin/phinx migrate -e production

            echo "ðŸ”„ Restarting web server..."
            sudo systemctl restart apache2 || sudo /opt/bitnami/ctlscript.sh restart apache

            echo "âœ… Backend deployment complete"
          EOF

      - name: Deploy frontend
        run: |
          echo "ðŸŽ¨ Deploying frontend to production..."
          rsync -avz -e "ssh -i ~/.ssh/lightsail.pem" \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude 'tests' \
            --exclude '.env' \
            public/ ubuntu@${{ steps.terraform-outputs.outputs.instance_ip }}:/var/www/html/

          echo "ðŸ”’ Setting file permissions..."
          ssh -i ~/.ssh/lightsail.pem ubuntu@${{ steps.terraform-outputs.outputs.instance_ip }} << 'EOF'
            sudo chown -R www-data:www-data /var/www/html
            sudo chmod -R 755 /var/www/html
          EOF
          echo "âœ… Frontend deployment complete"

      - name: Smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests..."
          sleep 5

          echo "Testing homepage..."
          if ! curl -f http://${{ steps.terraform-outputs.outputs.instance_ip }}/; then
            echo "âŒ Homepage test failed"
            exit 1
          fi
          echo "âœ… Homepage is accessible"

          echo "Testing API endpoint..."
          if ! curl -f http://${{ steps.terraform-outputs.outputs.instance_ip }}/api/events; then
            echo "âŒ API test failed"
            exit 1
          fi
          echo "âœ… API is responding"

          echo "ðŸŽ‰ All smoke tests passed!"

      - name: Deployment summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ================================"
            echo "âœ… DEPLOYMENT SUCCESSFUL"
            echo "âœ… ================================"
            echo "ðŸ“‹ Deployment Details:"
            echo "  - Branch: ${{ needs.check-ci-status.outputs.branch }}"
            echo "  - Environment: production"
            echo "  - URL: https://nsc-sdc.ca"
            echo "  - Instance IP: ${{ steps.terraform-outputs.outputs.instance_ip }}"
          else
            echo "âŒ ================================"
            echo "âŒ DEPLOYMENT FAILED"
            echo "âŒ ================================"
            echo "ðŸ“‹ Troubleshooting:"
            echo "  - Review the failed step above"
            echo "  - Check AWS credentials and permissions"
            echo "  - Verify Terraform state is valid"
            echo "  - Check instance connectivity"
            echo "  - Review application logs on the server"
          fi
