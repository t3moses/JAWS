# GitHub Actions CI/CD Pipeline for JAWS
# This file defines automated tests that run whenever code is pushed to the repository
# GitHub Actions is a CI/CD (Continuous Integration/Continuous Deployment) service
# that automatically runs tasks like tests, builds, and deployments

name: CI Pipeline

# Define when this workflow should run
on:
  # Run on every push to any branch
  push:
    branches: ['**']

  # Run on every pull request targeting main
  pull_request:
    branches: [main]

  # Allow manually triggering this workflow from the Actions tab
  workflow_dispatch:

# Define the jobs to run
# By separating build, database setup, and tests, we can:
# 1. Run unit tests immediately after dependencies are installed (no database needed)
# 2. Run database-dependent tests after database is ready
# 3. Maximize parallelism to reduce overall pipeline time
jobs:
  # ============================================================================
  # Job 1: Build Dependencies
  # This job installs PHP dependencies only
  # Fast and lightweight - just downloads packages
  # ============================================================================
  build:
    name: Build Dependencies

    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup PHP environment
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          extensions: pdo, pdo_sqlite, sqlite3, curl, mbstring, openssl
          coverage: none

      # Step 3: Validate composer.json
      - name: Validate Composer files
        run: composer validate --strict

      # Step 4: Cache Composer dependencies
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # Step 5: Install dependencies
      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      # Step 6: Upload vendor folder only
      # Unit tests only need dependencies, not the database
      - name: Upload vendor folder
        uses: actions/upload-artifact@v4
        with:
          name: vendor-artifacts
          path: vendor/
          retention-days: 1

  # ============================================================================
  # Job 2: Setup Database
  # This job creates and seeds the database
  # Runs in parallel with unit tests since they're independent
  # ============================================================================
  setup-database:
    name: Setup Database

    runs-on: ubuntu-latest

    # Needs build to complete first (requires vendor folder)
    needs: build

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup PHP environment
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          extensions: pdo, pdo_sqlite, sqlite3, curl, mbstring, openssl
          coverage: none

      # Step 3: Download vendor folder from build job
      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          name: vendor-artifacts
          path: vendor

      # Step 4: Create database directory
      - name: Create database directory
        run: mkdir -p database

      # Step 5: Run Phinx migrations
      - name: Run Phinx migrations
        run: php vendor/bin/phinx migrate -e development

      # Step 6: Seed test data
      - name: Seed test data
        run: php vendor/bin/phinx seed:run -e development

      # Step 8: Upload database as separate artifact
      # Integration and API tests will download this
      - name: Upload database artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-artifacts
          path: database/jaws.db
          retention-days: 1

  # ============================================================================
  # Job 3: Unit Tests
  # This job runs tests that check individual pieces of code in isolation
  # Unit tests don't need a database, so they can start immediately after build
  # This is now one of the FASTEST jobs in the pipeline
  # ============================================================================
  unit-tests:
    name: Run Unit Tests

    runs-on: ubuntu-latest

    # Only needs build job - can run in parallel with database setup
    needs: build

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          extensions: pdo, pdo_sqlite, sqlite3, curl, mbstring, openssl
          coverage: none

      # Step 3: Download vendor folder only (no database needed)
      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          name: vendor-artifacts
          path: vendor

      # Step 4: Run unit tests
      # These run immediately - no waiting for database!
      - name: Run unit tests
        run: php vendor/bin/phpunit Tests/Unit

  # ============================================================================
  # Job 4: Integration Tests
  # This job runs tests that check how different parts work together
  # Integration tests need both dependencies AND database
  # ============================================================================
  integration-tests:
    name: Run Integration Tests

    runs-on: ubuntu-latest

    # Must wait for BOTH build and database setup to complete
    needs: [build, setup-database]

    steps:
      # Get the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Install PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          extensions: pdo, pdo_sqlite, sqlite3, curl, mbstring, openssl
          coverage: none

      # Download vendor folder
      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          name: vendor-artifacts
          path: vendor

      # Download database
      - name: Download database artifacts
        uses: actions/download-artifact@v4
        with:
          name: database-artifacts
          path: database/

      # Run integration tests
      - name: Run integration tests
        run: php vendor/bin/phpunit Tests/Integration

  # ============================================================================
  # Job 5: API Tests
  # This job runs tests that verify the REST API endpoints work correctly
  # API tests need dependencies, database, AND a running web server
  # ============================================================================
  api-tests:
    name: Run API Tests

    runs-on: ubuntu-latest

    # Must wait for BOTH build and database setup to complete
    needs: [build, setup-database]

    steps:
      # Get the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Install PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.5'
          extensions: pdo, pdo_sqlite, sqlite3, curl, mbstring, openssl
          coverage: none

      # Download vendor folder
      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          name: vendor-artifacts
          path: vendor

      # Download database
      - name: Download database artifacts
        uses: actions/download-artifact@v4
        with:
          name: database-artifacts
          path: database/

      # Run API tests with web server
      - name: Run API tests
        run: |
          # Start PHP built-in web server in the background
          php -S localhost:8000 -t public > /dev/null 2>&1 &
          SERVER_PID=$!

          # Wait for server to start
          sleep 2

          # Run the API tests
          php Tests/Integration/api_test.php -v

          # Cleanup
          kill $SERVER_PID


  # ============================================================================
  # Job 6: Deploy to AWS Production
  # ============================================================================
#   deploy-production:
#     runs-on: ubuntu-latest
#     needs: localstack-validation
#     if: github.ref == 'refs/heads/main' && github.event_name == 'push'

#     environment:
#       name: production
#       url: https://nsc-sdc.ca

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: us-east-1

#       - name: Deploy backend to Lightsail
#         run: |
#           # Install SSH key
#           mkdir -p ~/.ssh
#           echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail.pem
#           chmod 600 ~/.ssh/lightsail.pem

#           # Add Lightsail to known hosts
#           ssh-keyscan -H nsc-sdc.ca >> ~/.ssh/known_hosts

#           # Deploy backend
#           ssh -i ~/.ssh/lightsail.pem ubuntu@nsc-sdc.ca << 'EOF'
#             cd /var/www/jaws
#             git pull origin main
#             composer install --no-dev --optimize-autoloader
#             vendor/bin/phinx migrate -e production
#             sudo systemctl restart apache2
#           EOF

#       - name: Deploy frontend to Lightsail
#         run: |
#           # Sync frontend files
#           rsync -avz -e "ssh -i ~/.ssh/lightsail.pem" \
#             --exclude '.git' \
#             --exclude 'node_modules' \
#             --exclude 'tests' \
#             nsc-sdc/ ubuntu@nsc-sdc.ca:/var/www/html/

#           # Set permissions
#           ssh -i ~/.ssh/lightsail.pem ubuntu@nsc-sdc.ca << 'EOF'
#             sudo chown -R www-data:www-data /var/www/html
#             sudo chmod -R 755 /var/www/html
#           EOF

#       - name: Run smoke tests
#         run: |
#           # Wait for deployment
#           sleep 10

#           # Test frontend
#           curl -f https://nsc-sdc.ca/ || exit 1

#           # Test API
#           curl -f https://nsc-sdc.ca/api/events || exit 1

#           echo "Smoke tests passed!"

#       - name: Notify deployment status
#         if: always()
#         uses: actions/github-script@v6
#         with:
#           script: |
#             const status = '${{ job.status }}';
#             const message = status === 'success'
#               ? '✅ Deployment to production succeeded!'
#               : '❌ Deployment to production failed!';

#             github.rest.issues.createComment({
#               owner: context.repo.owner,
#               repo: context.repo.repo,
#               issue_number: context.issue.number,
#               body: message
#             });
